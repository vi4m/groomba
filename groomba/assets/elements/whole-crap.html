<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">

<dom-module id="whole-crap">
  <style>
  </style>
  <template>
    <iron-ajax
        id="bookRoomResource"
        contentType="application/json"
        method="POST"
        debounce-duration="300">
    </iron-ajax>
    <iron-ajax
        id="freeRoomResource"
        handle-as="json"
        on-response="roomResourceHandler"
        debounce-duration="300">
    </iron-ajax>


    <paper-header-panel class="flex">
      <paper-toolbar>
          <div>App</div>
      </paper-toolbar>
      <paper-material elevation="4">
        <paper-input-container inline>
          <label>start date</label> <input id='start-date' value='2015-06-18' is="iron-input">
        </paper-input-container>
        -
        <paper-input-container inline>
          <label>start time</label> <input id='start-time' value='16:30' is="iron-input">
        </paper-input-container>
        <paper-input-container inline>
          <label>end date</label> <input id='end-date' value='2015-06-18' is="iron-input">
        </paper-input-container>
        -
        <paper-input-container inline>
          <label>end date</label> <input id='end-time' value='17:30' is="iron-input">
        </paper-input-container>

        <paper-button on-click='searchRoom' id='search'>
          <iron-icon icon="search"></iron-icon>
          search free rooms
        </paper-button>

        <template is="dom-repeat" id="menu" items="{{rooms}}">
          <paper-icon-item>
            <div class="flex">{{item.name}}</div>
            <paper-button on-click='bookRoom' value='{{item.id}}'>
              <iron-icon icon="lock"></iron-icon>
              book room
            </paper-button>
          </paper-icon-item>
        </template>

      </paper-material>
    </paper-header-panel>

  </template>
  <script>
    Polymer({
      is: "whole-crap",
      bookRoom: function () {
        console.log('bookRoom');
      },
      getDateTimeRange: function() {
        var startDateTime = new Date([
          document.querySelector('#start-date').value,
          document.querySelector('#start-time').value
        ].join(':'));
        var endDateTime = new Date([
          document.querySelector('#end-date').value,
          document.querySelector('#end-time').value
        ].join(':'));
        return [startDateTime, endDateTime];
      },
      roomResourceHandler: function (request) {
        console.log('roomResourceHandler');
        console.log('populating..');
        this.rooms = [{
          'name': 'n1',
          'id': 'id1'
        }, {
          'name': 'n2',
          'id': 'id2'
        }];
        //this.rooms = request.detail.response['rooms'];
        console.log('populated');
      },
      searchRoom: function () {
        console.log('searchRoom');
        this.dateTimeRange = this.getDateTimeRange();
        var url = [
          "/api/available-rooms",
          this.dateTimeRange[0].toISOString(),
          this.dateTimeRange[0].toISOString(),
          ''
        ].join('/');
        this.$.freeRoomResource.url = url;
        console.log(url);
        //this.$.freeRoomResource.generateRequest();
        this.roomResourceHandler();
      },
      bookRoom: function (event) {
        console.log('bookRoom');
        this.$.bookRoomResource.url = "/api/create-event/";
        this.dateTimeRange = this.getDateTimeRange();
        var data = {
          'start': this.dateTimeRange[0].toISOString(),
          'end': this.dateTimeRange[1].toISOString(),
          'room_id': event.target.parentElement.value,
          'summary': 'test desctiption',
          'description': 'sample event'
        };
        this.$.bookRoomResource.body = JSON.stringify(data);
        console.log(this.$.bookRoomResource.url, data);
        //this.$.bookRoomResource.generateRequest();
      },
      ready: function () {
        this.rooms = [];
      }
    });
  </script>
</dom-module>
